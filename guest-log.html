<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Log</title>

    <!-- jsPDF + AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --danger: #ef4444;
            --border: #e5e7eb;
        }

        body {
            font-family: system-ui, sans-serif;
            margin: 0;
            background: var(--bg);
        }

        /* ---------- CONTROLS ---------- */

        .controls {
            padding: 12px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-reset {
            background: var(--danger);
        }

        .btn-pdf {
            background: var(--primary);
        }

        /* ---------- LOG CARDS ---------- */

        #mobileView {
            padding: 10px;
            padding-bottom: 60px;
        }

        .log-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 14px;
            border: 1px solid var(--border);
        }

        .card-header {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        /* ---------- RESPONSIVE GRID ---------- */

        .grid-inputs {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        @media (min-width: 600px) {
            .grid-inputs {
                grid-template-columns: 1fr 1fr;
            }
        }

        .field {
            display: flex;
            flex-direction: column;
            font-size: 12px;
            color: #555;
        }

        .field input {
            margin-top: 4px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-height: 20px;
        }

        .field input[readonly] {
            background: #f1f5f9;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="controls">
        <div class="input-row">
            <input type="month" id="month" onchange="generate()">
            <input type="number" id="startKM" placeholder="Start KM" oninput="saveAndCalc()">
        </div>
        <div class="btn-group">
            <button class="btn-reset" onclick="clearAll()">Clear Data</button>
            <button class="btn-pdf" onclick="exportPDF()">Export PDF</button>
        </div>
    </div>

    <div id="mobileView"></div>

    <script>
        function saveAndCalc() {
            const monthKey = month.value;
            const startKMVal = startKM.value;

            const dailyData = {};
            document.querySelectorAll(".log-card").forEach(card => {
                const day = card.dataset.day;
                dailyData[day] = {
                    st: card.querySelector(".m-st").value,
                    ct: card.querySelector(".m-ct").value,
                    t: card.querySelector(".m-t").value,
                    p: card.querySelector(".m-p").value
                };
            });

            localStorage.setItem(
                `log_${monthKey}`,
                JSON.stringify({ startKM: startKMVal, dailyData })
            );

            calc();
        }

        function loadData() {
            const saved = localStorage.getItem(`log_${month.value}`);
            return saved ? JSON.parse(saved) : null;
        }

        function clearAll() {
            if (confirm("Delete this month's data?")) {
                localStorage.removeItem(`log_${month.value}`);
                generate();
            }
        }

        function generate() {
            if (!month.value) return;

            const [y, mo] = month.value.split("-");
            const days = new Date(y, mo, 0).getDate();
            const monShort = new Date(y, mo - 1).toLocaleString("en", { month: "short" });

            mobileView.innerHTML = "";
            const saved = loadData();
            if (saved) startKM.value = saved.startKM;

            for (let i = 1; i <= days; i++) {
                const dateStr = `${String(i).padStart(2, "0")}-${monShort}-${y.slice(-2)}`;
                const d = saved?.dailyData?.[i] || {};

                mobileView.innerHTML += `
          <div class="log-card" data-day="${i}">
            <div class="card-header">${dateStr}</div>
            <div class="grid-inputs">
              <div class="field">Start KM <input class="m-s" readonly></div>
              <div class="field">Close KM <input class="m-c" readonly></div>

              <div class="field">Total KM <input type="number" class="m-t" value="${d.t || ""}" oninput="saveAndCalc()"></div>
              <div class="field">Parking <input type="number" class="m-p" value="${d.p || ""}" oninput="saveAndCalc()"></div>

              <div class="field">Start Time <input type="time" class="m-st" value="${d.st || ""}" oninput="saveAndCalc()"></div>
              <div class="field">Close Time <input type="time" class="m-ct" value="${d.ct || ""}" oninput="saveAndCalc()"></div>
            </div>
          </div>`;
            }
            calc();
        }

        function calc() {
            let km = +startKM.value || 0;
            document.querySelectorAll(".log-card").forEach(card => {
                const total = +card.querySelector(".m-t").value || 0;
                if (total) {
                    card.querySelector(".m-s").value = km;
                    card.querySelector(".m-c").value = km + total;
                    km += total;
                } else {
                    card.querySelector(".m-s").value = "";
                    card.querySelector(".m-c").value = "";
                }
            });
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("landscape", "mm", "a4");

            doc.setFontSize(14);
            const [year, monthNum] = month.value.split("-");
            const monthName = new Date(year, monthNum - 1)
                .toLocaleString("en", { month: "long" });

            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text(
                "Vehicle Log Sheet - " + monthName + " " + year,
                148,
                10,
                { align: "center" }
            );


            const body = [];

            document.querySelectorAll(".log-card").forEach(card => {
                body.push([
                    card.querySelector(".card-header").innerText,
                    card.querySelector(".m-s").value,
                    card.querySelector(".m-st").value,
                    card.querySelector(".m-c").value,
                    card.querySelector(".m-ct").value,
                    card.querySelector(".m-t").value,
                    card.querySelector(".m-p").value,
                    ""
                ]);
            });

            doc.autoTable({
                startY: 15,
                head: [[
                    "Date", "Garage Starting KM", "Garage Starting Time",
                    "Garage Closing KM", "Garage Closing Time",
                    "Total KM", "Parking", "Guest Signature"
                ]],
                body,
                styles: {
                    fontSize: 9,
                    halign: "center",
                    cellPadding: 1, textColor: [0, 0, 0], // pure black
                    lineColor: [0, 0, 0], // pure black borders
                    lineWidth: 0.2,
                    fillColor: false
                },
                theme: "grid",
                headStyles: {
                    fillColor: [230, 230, 230], // light neutral gray
                    textColor: [0, 0, 0],
                    lineColor: [0, 0, 0],
                    lineWidth: 0.2,
                    fontStyle: "bold"
                },

                columnStyles: {
                    0: { cellWidth: 30 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 35 },
                    4: { cellWidth: 35 },
                    5: { cellWidth: 25 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 50 }
                }
            });

            doc.save("Vehicle_Log_" + month.value + ".pdf");
        }


        month.value = new Date().toISOString().slice(0, 7);
        generate();
    </script>

</body>

</html>
